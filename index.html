<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Web Bluetooth API Console</title>
</head>
 
<body>
<form name="js">
<h1>Web Bluetooth API Console</h1>
<input type="button" value="接続" onclick="connect();"/> 
<input type="button" value="切断" onclick="disconnect();" /> 
<br />
<input type="text" id="sendInput" />
<input type="button" value="Send" onclick="SendButton_click();" />
<br />

<hr>
    <p>外部データ</p>
    <ul>
        <li id="ex_data1">0</li>
        <li id="ex_data2">0</li>
        <li id="ex_data3">0</li>
		<li id="ex_data4">0</li>
		<li id="ex_data5">0</li>
		<li id="ex_data6">0</li>
		<li id="ex_data7">0</li>
		<li id="ane_speed">0</li>
		<li id="ane_temp">0</li>
    </ul>
	<input type="button" value="ゼロオフセット" onclick="ane_offset_click();"/> 
</form>

<script>

	// BLE接続用
	let keyDevice;
	let keyServer;
	let keyService;
	
	//var accelerometer_device;
	//var accelerometer_characteristic;
	 
	//micro:bit BLE UUID
	//var ACCELEROMETERSERVICE_SERVICE_UUID       = 'e95d0753-251d-470a-a062-fa1922dfa9a8';
	//var ACCELEROMETERSERVICE_SERVICE_UUID       = '01020304-0506-0708-0900-0a0b0c0d0e0f';
	//var ACCELEROMETERDATA_CHARACTERISTIC_UUID   = 'e95dca4b-251d-470a-a062-fa1922dfa9a8';
	//var ACCELEROMETERDATA_CHARACTERISTIC_UUID   = '11223344-5566-7788-9900-aabbccddeefe';
	
	var SENSORLOGGER_SERVICE_UUID          = '6f565fda-2747-492a-76af-bed5cbed5bf1';
	var COMMAND_WRITE_CHARACTERISTIC_UUID  = '6f565f01-2747-492a-76af-bed5cbed5bf1';
	var SENSOR_READ_CHARACTERISTIC_UUID    = '6f565f81-2747-492a-76af-bed5cbed5bf1';
	var GPS_READ_CHARACTERISTIC_UUID       = '6f565f82-2747-492a-76af-bed5cbed5bf1';
	var EXTERNAL_READ_CHARACTERISTIC_UUID  = '6f565f83-2747-492a-76af-bed5cbed5bf1';
	var STATUS_READ_CHARACTERISTIC_UUID    = '6f565f84-2747-492a-76af-bed5cbed5bf1';
	var EEPROM_READ_CHARACTERISTIC_UUID    = '6f565f85-2747-492a-76af-bed5cbed5bf1';


	var accel = [0, 0, 0];
    var gyro = [0, 0, 0];
    var mag = [0, 0, 0];
    var euler = [0, 0, 0];
	var ex_data = [0, 0, 0, 0, 0, 0, 0];
	
	var imu_temp = 0;
	var pressure = 0;
    var pres_temp = 0;
    var altitude = 0;
	var sd_status = false;
    var gps_status = false;
    var battery = 0;
    var pressure_zero = 1013;
	var ane_speed = 0;
	var ane_temp = 0;
	var ane_offset = 0;

 
	function connect() {
	  navigator.bluetooth.requestDevice({
		filters: [{ namePrefix: 'RN', }],
		optionalServices: [SENSORLOGGER_SERVICE_UUID]
	  })
	  .then(device => {
		keyDevice = device;
		console.log("device", device);
		return device.gatt.connect();
	  })
	  //ACCELEROMETER
	  .then(server =>{
		keyServer = server;
		console.log("server", server)
		return server.getPrimaryService(SENSORLOGGER_SERVICE_UUID);
	  })
	  .then(service => {
		keyService = service;
		console.log("service", service)
		//return service.getCharacteristic(ACCELEROMETERDATA_CHARACTERISTIC_UUID)
		return Promise.all([
        service.getCharacteristic(COMMAND_WRITE_CHARACTERISTIC_UUID),
        service.getCharacteristic(SENSOR_READ_CHARACTERISTIC_UUID),
		service.getCharacteristic(GPS_READ_CHARACTERISTIC_UUID),
        service.getCharacteristic(EXTERNAL_READ_CHARACTERISTIC_UUID),
		service.getCharacteristic(STATUS_READ_CHARACTERISTIC_UUID),
        service.getCharacteristic(EEPROM_READ_CHARACTERISTIC_UUID)
    ]); 
	  })
	  .then(chara => {
		console.log("characteristic:", chara)
		//alert("BLE接続が完了しました。");
		/*characteristic = chara;
		characteristic.startNotifications();
		characteristic.addEventListener('characteristicvaluechanged',onAccelerometerValueChanged); */ 
		
		//chara[1].startNotifications();
		//chara[2].startNotifications();
		chara[3].startNotifications();
		//chara[4].startNotifications();
		
		//chara[1].oncharacteristicvaluechanged = onSensorReadValueChanged;
		//chara[2].oncharacteristicvaluechanged = onGPSReadValueChanged;
		chara[3].oncharacteristicvaluechanged = onExternalReadValueChanged;
		//chara[4].oncharacteristicvaluechanged = onStatusReadValueChanged;
		
	  })  
	  .catch(error => {
		alert("BLE接続に失敗しました。もう一度試してみてください");
		console.log(error);
	  });    
	}
	
	function SendButton_click() {
		const text = document.getElementById('sendInput').value;
		document.getElementById('sendInput').value = "";

		var buffer = (new TextEncoder).encode(text);
		
		keyService.getCharacteristic(COMMAND_WRITE_CHARACTERISTIC_UUID)
        .then(characteristic => {
            characteristic.writeValue(buffer);
		//chara[0].writeValue(buffer);
		//sendSerial(text + "\n");
		})
    }
	 	
	function onExternalReadValueChanged(event) {
		let dat = new DataView(event.target.value.buffer, 0);
		
		ex_data[0] = dat.getInt16(0, false);
		ex_data[1] = dat.getInt16(2, false);
		ex_data[2] = dat.getInt16(4, true);
		ex_data[3] = dat.getInt16(6, true);
		ex_data[4] = dat.getInt16(8, true);
		ex_data[5] = dat.getInt16(10, true);
		ex_data[6] = dat.getInt16(12, true);
		
		ane_temp = (ex_data[1] - 511) * 0.09765625;
		d = 395.673 * Math.sqrt((ex_data[0]+ane_offset)*0.0676*(1.0+0.00366*ane_temp)/101325.0);
		if(d >= 1){
			ane_speed = d;
		}
		else{
			ane_speed = 0;
		}
		
		document.getElementById('ex_data1').textContent = String(ex_data[0]);
		document.getElementById('ex_data2').textContent = String(ex_data[1]);
		document.getElementById('ex_data3').textContent = String(ex_data[2]);
		document.getElementById('ex_data4').textContent = String(ex_data[3]);
		document.getElementById('ex_data5').textContent = String(ex_data[4]);
		document.getElementById('ex_data6').textContent = String(ex_data[5]);
		document.getElementById('ex_data7').textContent = String(ex_data[6]);
		document.getElementById('ane_speed').textContent = "風速=" + String(ane_speed.toFixed(1)) + "m/s";
		document.getElementById('ane_temp').textContent = "温度=" + String(ane_temp.toFixed(1)) + "℃";
	}
		 
	function disconnect() {
	  if (!keyDevice || !keyDevice.gatt.connected) return ;
	  keyDevice.gatt.disconnect();
	  alert("BLE接続を切断しました。")
	}
	
	function ane_offset_click() {
	  ane_offset = 0 - ex_data[0];
	}
 
</script>    
</body>
</html>
